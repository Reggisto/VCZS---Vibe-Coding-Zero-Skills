<script>
    let generatedCode = "";

    async function generateCode() {
        const key = document.getElementById('apiKey').value;
        const promptText = document.getElementById('prompt').value;
        const btn = document.getElementById('genBtn');
        const loader = document.getElementById('loading');

        if(!key || !promptText) return alert("Manca Key o Prompt!");

        btn.disabled = true;
        loader.classList.remove('hidden');

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `Genera un file HTML unico (con CSS Tailwind e JS incluso) per questa idea: ${promptText}. Rispondi SOLO col codice, senza spiegazioni o markdown.`
                        }]
                    }]
                })
            });

            const data = await response.json();
            console.log("Risposta API completa:", data); // per debug in console

            if (!response.ok) {
                alert("Errore API: " + response.status + " - " + response.statusText);
                return;
            }

            if (!data.candidates || data.candidates.length === 0) {
                alert("Gemini non ha restituito candidati validi. Controlla key o prompt.");
                return;
            }

            let rawCode = data.candidates[0].content.parts[0].text || "";
            
            generatedCode = rawCode.replace(/```html|```/g, "").trim();

            const iframe = document.getElementById('preview');
            iframe.srcdoc = generatedCode;
            
            document.getElementById('resultSection').classList.remove('hidden');
        } catch (error) {
            alert("Errore durante la generazione: " + error.message);
            console.log("Errore dettagliato:", error);
        } finally {
            btn.disabled = false;
            loader.classList.add('hidden');
        }
    }

    function copyCode() {
        navigator.clipboard.writeText(generatedCode);
        alert("Codice copiato!");
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js');
        });
    }
</script>
