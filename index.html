    <script>
        let generatedCode = "";

        async function generateCode() {
            const key = document.getElementById('apiKey').value.trim();
            const promptText = document.getElementById('prompt').value.trim();
            const btn = document.getElementById('genBtn');
            const loader = document.getElementById('loading');
            const resultSection = document.getElementById('resultSection');

            if (!key || !promptText) {
                alert("Inserisci API Key e descrizione!");
                return;
            }

            btn.disabled = true;
            btn.style.opacity = "0.5";
            loader.classList.remove('hidden');
            resultSection.classList.add('hidden');

            try {
                // Endpoint STABILE v1 con il modello corretto
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${key}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Crea un file HTML unico, completo di CSS (Tailwind) e JS, per questa idea: "${promptText}". Rispondi SOLO con il codice puro, senza blocchi markdown o testo extra.`
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "Errore API");
                }

                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    let rawCode = data.candidates[0].content.parts[0].text;
                    
                    // Pulizia accurata del codice
                    generatedCode = rawCode.replace(/```html/gi, "").replace(/```/g, "").trim();

                    const iframe = document.getElementById('preview');
                    // Usiamo srcdoc per semplicitÃ  di ricaricamento immediato
                    iframe.srcdoc = generatedCode;

                    resultSection.classList.remove('hidden');
                    setTimeout(() => resultSection.scrollIntoView({ behavior: 'smooth' }), 300);
                } else {
                    throw new Error("Risposta vuota da Gemini.");
                }

            } catch (error) {
                console.error(error);
                alert("Errore: " + error.message);
            } finally {
                btn.disabled = false;
                btn.style.opacity = "1";
                loader.classList.add('hidden');
            }
        }

        document.getElementById('genBtn').onclick = (e) => {
            e.preventDefault();
            generateCode();
        };

        function copyCode() {
            navigator.clipboard.writeText(generatedCode);
            alert("Codice copiato!");
        }
    </script>
