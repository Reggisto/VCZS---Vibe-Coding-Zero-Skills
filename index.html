    <script>
        let lastGeneratedCode = "";

        async function runGeneration() {
            const key = document.getElementById('apiKey').value.trim();
            const promptInput = document.getElementById('prompt').value.trim();
            const btn = document.getElementById('genBtn');
            const loader = document.getElementById('loading');
            const result = document.getElementById('resultSection');

            if (!key || !promptInput) {
                alert("Mancano dati!");
                return;
            }

            btn.disabled = true;
            btn.style.opacity = "0.5";
            loader.classList.remove('hidden');
            result.classList.add('hidden');

            try {
                // Endpoint aggiornato con la stringa modello specifica che risolve l'errore negli screenshot
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${key}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Crea un file HTML5 singolo e completo (CSS Tailwind e JS inclusi) per questa idea: "${promptInput}". Rispondi ESCLUSIVAMENTE con il codice HTML puro, senza markdown (\`\`\`), senza spiegazioni e senza testo aggiuntivo.`
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Se l'errore persiste, mostriamo il messaggio esatto dell'API per capire se Ã¨ un problema di permessi della Key
                    throw new Error(data.error?.message || "Errore sconosciuto");
                }

                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    let code = data.candidates[0].content.parts[0].text;
                    
                    // Pulizia aggressiva nel caso l'IA ignori l'istruzione e metta comunque i ```
                    lastGeneratedCode = code.replace(/```html/gi, "").replace(/```/g, "").trim();

                    const iframe = document.getElementById('preview');
                    iframe.srcdoc = lastGeneratedCode;

                    result.classList.remove('hidden');
                    result.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error("L'API non ha restituito codice. Controlla i limiti della tua Key.");
                }

            } catch (err) {
                alert("Errore Tecnico: " + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.style.opacity = "1";
                loader.classList.add('hidden');
            }
        }

        function copyToClipboard() {
            if (!lastGeneratedCode) return;
            navigator.clipboard.writeText(lastGeneratedCode);
            alert("Codice copiato!");
        }
    </script>
