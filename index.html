<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe-Oracle v1.3 | Rebalancing Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0a0b0d; color: #00ff41; font-family: monospace; font-size: 12px; }
        .panel { border: 1px solid #1e293b; background: #111827; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        input { background: #1f2937 !important; color: #00ff41 !important; border: 1px solid #374151 !important; width: 50px; text-align: center; border-radius: 4px; }
        .section-title { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; border-bottom: 1px solid #1e293b; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        #console-output { background: #000; color: #00ff41; padding: 10px; font-size: 10px; min-height: 150px; border: 1px dashed #00ff41; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body class="p-3">

    <div class="flex justify-between items-center mb-3">
        <h1 class="font-bold text-green-500">ORACLE v1.3 [AUTO-COMPOUND]</h1>
        <div id="token-status" class="text-[9px] text-red-500 font-bold uppercase">Tokens: 0</div>
    </div>

    <div class="panel">
        <div class="section-title">Allocazione Wallet (%)</div>
        <div class="row"><span>DUTCH ARB</span> <input type="number" id="alloc-dutch" value="50" onchange="normAlloc('alloc-dutch')">%</div>
        <div class="row"><span>METEO</span> <input type="number" id="alloc-meteo" value="30" onchange="normAlloc('alloc-meteo')">%</div>
        <div class="row"><span>RARE</span> <input type="number" id="alloc-rare" value="20" onchange="normAlloc('alloc-rare')">%</div>
    </div>

    <div class="panel">
        <div class="section-title">Destinazione Profitti (%)</div>
        <div class="mb-4">
            <p class="text-[9px] text-yellow-500 italic mb-1">Da Profitti Meteo verso:</p>
            <div class="flex gap-2">
                <span>Dutch <input type="number" id="m-to-d" value="80" onchange="normProfit('m')"></span>
                <span>Meteo <input type="number" id="m-to-m" value="20" onchange="normProfit('m')"></span>
            </div>
        </div>
        <div>
            <p class="text-[9px] text-yellow-500 italic mb-1">Da Profitti Rare verso:</p>
            <div class="flex gap-2">
                <span>Dutch <input type="number" id="r-to-d" value="80" onchange="normProfit('r')"></span>
                <span>Rare <input type="number" id="r-to-r" value="20" onchange="normProfit('r')"></span>
            </div>
        </div>
    </div>

    <div class="panel space-y-2">
        <input type="password" id="apiKey" placeholder="GEMINI API KEY" class="w-full mb-2 text-left px-2">
        <div class="grid grid-cols-2 gap-2">
            <button id="btn-mode" onclick="toggleMode()" class="bg-blue-900 py-2 rounded font-bold">MODE: DEMO</button>
            <button onclick="fabbricaOracle()" class="bg-green-600 text-black py-2 rounded font-bold uppercase">Inizializza</button>
        </div>
    </div>

    <div id="console-output">[SISTEMA PRONTO]<br>Normalizzazione attiva.</div>

    <script>
        let isReal = false;

        // Normalizza allocazione iniziale (Somma 100)
        function normAlloc(lastId) {
            let d = parseInt(document.getElementById('alloc-dutch').value) || 0;
            let m = parseInt(document.getElementById('alloc-meteo').value) || 0;
            let r = parseInt(document.getElementById('alloc-rare').value) || 0;
            let total = d + m + r;
            if(total > 100) {
                let diff = total - 100;
                let val = parseInt(document.getElementById(lastId).value);
                document.getElementById(lastId).value = val - diff;
            }
        }

        // Normalizza destinazione profitti (Somma 100 per riga)
        function normProfit(type) {
            let d = parseInt(document.getElementById(type+'-to-d').value) || 0;
            let target = parseInt(document.getElementById(type+'-to-'+(type==='m'?'m':'r')).value) || 0;
            if(d + target > 100) {
                document.getElementById(type+'-to-'+(type==='m'?'m':'r')).value = 100 - d;
            }
        }

        function toggleMode() {
            isReal = !isReal;
            const b = document.getElementById('btn-mode');
            b.innerText = isReal ? "MODE: REAL" : "MODE: DEMO";
            b.className = isReal ? "bg-red-900 py-2 rounded font-bold" : "bg-blue-900 py-2 rounded font-bold";
        }

        async function fabbricaOracle() {
            const key = document.getElementById('apiKey').value.trim();
            const out = document.getElementById('console-output');
            if(!key) return alert("Inserisci API Key");
            
            out.innerHTML = "> Iniezione logica Compound & Rebalancing...<br>> Connessione WebSocket Binance...";
            
            const prompt = `Genera dashboard trading per Polymarket. 
            Calcola Compound basato su: Meteo->Dutch (${document.getElementById('m-to-d').value}%), Rare->Dutch (${document.getElementById('r-to-d').value}%). 
            Usa WebSocket Binance prezzi live. Visualizza ROI cumulativo.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if(data.candidates) {
                    document.getElementById('token-status').innerText = "TOKENS: " + data.usageMetadata.totalTokenCount;
                    document.getElementById('token-status').style.color = "#00ff41";
                    out.innerHTML = data.candidates[0].content.parts[0].text.replace(/```html/gi, "").replace(/```/g, "");
                }
            } catch (e) { out.innerHTML = "[ERRORE] " + e.message; }
        }
    </script>
</body>
</html>
